<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blipz - Location Chat</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üí¨</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
		<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <a href="#main-content" class="skip-link">Skip to main content</a>
    
    <header role="banner">
        <div class="header-nav">
            <h1>Blipz</h1>
            <div class="nav-controls">
                <button class="theme-toggle" id="theme-toggle" title="Toggle dark mode" aria-label="Toggle dark mode">
                    <span id="theme-icon" aria-hidden="true">üåô</span>
                </button>
                <button class="sound-toggle" id="sound-toggle" title="Toggle sound notifications" aria-label="Toggle sound notifications">
                    <span id="sound-icon" aria-hidden="true">üîä</span>
                </button>
            </div>
        </div>
    </header>

    <main id="main-content" role="main">
        <!-- Live region for dynamic announcements -->
        <div id="live-announcements" class="sr-only" aria-live="assertive" aria-atomic="true"></div>
        
			<div class="sidebar" role="complementary" aria-label="Chat room controls">
				<div id="map-card" class="card" aria-label="Map view">
					<h3>Map</h3>
					<div id="map" role="application" aria-label="Geohash map"></div>
					<div id="map-overlays" aria-hidden="false">
						<div class="overlay-panel overlay-top-left">
							<label for="map-radius-input">Radius (km)</label>
							<div class="overlay-row">
								<input type="number" id="map-radius-input" class="form-input" value="5" min="1" max="50" aria-label="Search radius in kilometers">
								<button id="map-search-btn" class="btn btn-primary">Search</button>
							</div>
						</div>
						<div class="overlay-panel overlay-middle-left">
							<label>Activity Filters</label>
							<div class="filter-controls">
								<div class="filter-row">
									<input type="checkbox" id="filter-active" class="filter-checkbox" checked>
									<label for="filter-active" class="filter-label">üü¢ Active now</label>
								</div>
								<div class="filter-row">
									<input type="checkbox" id="filter-trending" class="filter-checkbox">
									<label for="filter-trending" class="filter-label">üî• Trending (60m)</label>
								</div>
								<div class="filter-row">
									<input type="checkbox" id="filter-new" class="filter-checkbox">
									<label for="filter-new" class="filter-label">‚ú® New rooms (10m)</label>
								</div>
							</div>
							<div class="time-window-selector">
								<label for="time-window">Time window:</label>
								<select id="time-window" class="form-select">
									<option value="15">15 minutes</option>
									<option value="60" selected>1 hour</option>
									<option value="1440">24 hours</option>
								</select>
							</div>
						</div>
						<div class="overlay-panel overlay-top-right">
							<label for="map-room-id-input">Join by ID</label>
							<div class="overlay-row">
								<input type="text" id="map-room-id-input" class="form-input" placeholder="6-char geohash" maxlength="6" aria-label="Room ID">
								<button id="map-join-btn" class="btn btn-primary">Join</button>
							</div>
						</div>
						<div class="overlay-panel overlay-bottom-left">
							<div class="overlay-row">
								<span class="info-label">Name:</span>
								<span id="map-user-name" class="info-value">Loading...</span>
								<button id="map-change-name-btn" class="btn btn-secondary btn-sm" aria-label="Edit your name">Edit</button>
							</div>
						</div>
						<div class="overlay-panel overlay-bottom-right">
							<button id="map-recenter-btn" class="btn btn-secondary btn-sm" title="Return to your location" aria-label="Return to your current location">
								<span aria-hidden="true">üß≠</span> My Location
							</button>
						</div>
						<div class="overlay-panel overlay-middle-right">
							<div class="map-legend">
								<h4 class="legend-title">Map Legend</h4>
								<div class="legend-items">
									<div class="legend-item">
										<div class="legend-color legend-active"></div>
										<span class="legend-text">Active rooms</span>
									</div>
									<div class="legend-item">
										<div class="legend-color legend-trending"></div>
										<span class="legend-text">Trending rooms</span>
									</div>
									<div class="legend-item">
										<div class="legend-color legend-new"></div>
										<span class="legend-text">New rooms</span>
									</div>
									<div class="legend-item">
										<div class="legend-color legend-inactive"></div>
										<span class="legend-text">Available spots</span>
									</div>
								</div>
								<div class="heat-scale">
									<div class="heat-label">Activity Level:</div>
									<div class="heat-gradient">
										<span class="heat-min">Low</span>
										<div class="heat-bar"></div>
										<span class="heat-max">High</span>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
            <div id="user-info" class="card">
                <h3>Your Profile</h3>
                <div class="user-avatar-section">
                    <img id="user-avatar-preview" class="avatar" src="" alt="Your avatar">
                    <div>
                        <button id="change-avatar-btn" class="btn btn-secondary btn-sm">Change Avatar</button>
                    </div>
                </div>
                
                <div class="user-info-item">
                    <span class="info-label">Name:</span>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span id="user-name" class="info-value">Loading...</span>
                        <button id="change-name-btn" class="btn btn-secondary btn-sm" aria-label="Edit your name">Edit</button>
                    </div>
                </div>
                
                <div class="user-info-item">
                    <span class="info-label">User ID:</span>
                    <span id="user-id" class="info-value">Loading...</span>
                </div>
                
                <div class="user-info-item">
                    <span class="info-label">Location:</span>
                    <span id="geohash" class="info-value">Detecting...</span>
                </div>

                <div class="privacy-toggle-container">
                    <label for="privacy-toggle" style="flex: 1; font-weight: 500;">Privacy Mode</label>
                    <input type="checkbox" id="privacy-toggle" aria-describedby="privacy-description">
                    <div id="privacy-description" class="sr-only">Toggle privacy mode to hide your location from other users</div>
                </div>
            </div>

            <div id="join-room-by-id" class="card">
                <h3>Join Room by ID</h3>
                <div class="join-room-form">
                    <div class="input-group">
                        <label for="room-id-input">Room ID (Geohash) <span class="shortcut-hint">Press 'R' to focus</span></label>
                        <input type="text" id="room-id-input" class="form-input" placeholder="Enter 6-character room ID..." title="Press Enter to join" aria-describedby="room-id-help">
                        <div id="room-id-help" class="sr-only">Enter a 6-character room ID to join a specific chat room</div>
                    </div>
                    <button id="join-by-id-btn" class="btn btn-primary" aria-describedby="room-id-input">Join</button>
                </div>
            </div>

            <div id="recent-rooms" class="card">
                <h3>Recently Joined</h3>
                <ul class="rooms-list" role="list" aria-label="Recently joined chat rooms">
                    <!-- Recently joined rooms will be listed here -->
                </ul>
            </div>

            <div id="nearby-rooms" class="card">
                <h3>Nearby Chat Rooms</h3>
                <div class="radius-control">
                    <div class="input-group">
                        <label for="radius-input">Search Radius (km)</label>
                        <input type="number" id="radius-input" class="form-input" value="5" min="1" max="50" aria-describedby="radius-help">
                        <div id="radius-help" class="help-text">Set the search radius between 1-50 km to find nearby chat rooms</div>
                    </div>
                    <button id="search-radius-btn" class="btn btn-primary">Search</button>
                </div>
                <ul class="rooms-list" role="list" aria-label="Nearby chat rooms">
                    <!-- Chat rooms will be listed here -->
                </ul>
            </div>
        </div>

        <div class="chat-container" role="main" aria-label="Chat messages">
            <div id="chat-room" class="card">
                <div class="chat-header">
                    <div class="chat-title-section">
                        <button id="back-to-rooms-btn" class="back-btn" title="Back to room selection" style="display: none;" aria-label="Back to room selection">
                            <span aria-hidden="true">‚Üê</span>
                        </button>
                        <h2 class="chat-title">Select a Chat Room</h2>
                    </div>
                    <div class="chat-actions">
                        <button id="copy-room-link-btn" class="btn btn-secondary btn-sm" title="Copy room link" style="display: none;" aria-label="Copy room link">
                            <span aria-hidden="true">üîó</span> Copy Link
                        </button>
                        <div id="user-count" aria-live="polite">0 online</div>
                    </div>
                </div>
                
                <div id="messages" role="log" aria-live="polite" aria-label="Chat messages">
                    <div class="spinner-container">
                        <div class="spinner" aria-label="Loading"></div>
                    </div>
                    <!-- Messages will be displayed here -->
                </div>
                
                <div id="typing-indicator" aria-live="polite" aria-label="Typing indicator"></div>
                
                <div id="reply-context" style="display: none;" role="status">
                    <span id="reply-context-text"></span>
                    <button id="cancel-reply-btn" aria-label="Cancel reply">√ó</button>
                </div>
                
                <div id="message-input" role="form" aria-label="Send message">
                    <button id="emoji-btn" title="Add emoji" aria-label="Add emoji">üòä</button>
                    <label for="new-message" class="sr-only">Type your message</label>
                    <textarea id="new-message" class="form-input" placeholder="Type a message..." rows="1" aria-label="Type your message"></textarea>
                    <button id="send-button" class="btn btn-primary">Send</button>
                </div>
            </div>
        </div>
    </main>

    <!-- Geohash Room Popup -->
    <div id="geohash-popup" class="modal-overlay" style="display: none;" role="dialog" aria-labelledby="popup-title" aria-describedby="popup-description">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="popup-title">Chat Room</h2>
                <button class="modal-close" id="close-popup" aria-label="Close popup">√ó</button>
            </div>
            <div class="modal-body">
                <div class="geohash-popup-content">
                    <div class="popup-geohash-display">
                        <span class="popup-label">Room ID:</span>
                        <span id="popup-geohash" class="popup-value"></span>
                    </div>
                    <div class="popup-status">
                        <span id="popup-status" class="popup-status-text"></span>
                    </div>
                    <p id="popup-description" class="popup-description"></p>
                    <div class="popup-actions">
                        <button id="popup-enter-btn" class="btn btn-primary"></button>
                        <button id="popup-cancel-btn" class="btn btn-secondary">Cancel</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="libs/ngeohash.js" defer></script>
    <script src="libs/emoji-picker-simple.js" defer></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js" defer></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js" defer></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js" defer></script>
		<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="" defer></script>
    <script src="script.js" defer></script>
</body>
</html>
